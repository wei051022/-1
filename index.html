<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>钥匙管理系统</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        h1, h2 { text-align: center; }
        form { margin-bottom: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        label, input, select, button { display: block; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        input[type="text"], input[type="password"], select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #4CAF50; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-buttons { text-align: center; margin-bottom: 20px; }
        .tab-buttons button { width: auto; display: inline-block; margin: 0 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div class="container">
    <h1>钥匙管理系统</h1>

    <div id="login-tab" class="tab-content active">
        <h2>登录</h2>
        <form id="login-form">
            <label for="username">用户名:</label>
            <input type="text" id="username" name="username" required>
            <label for="password">密码:</label>
            <input type="password" id="password" name="password" required>
            <button type="submit">登录</button>
        </form>
        <p id="message" style="text-align: center; color: red;"></p>
    </div>

    <div id="main-tab" class="tab-content">
        <div class="tab-buttons">
            <button onclick="showTab('add-key-tab')">添加钥匙</button>
            <button onclick="showTab('manage-keys-tab')">管理钥匙</button>
            <button onclick="logout()">退出登录</button>
        </div>

        <div id="add-key-tab" class="tab-content active">
            <h2>添加钥匙</h2>
            <form id="add-key-form">
                <label for="add-id">ID:</label>
                <input type="text" id="add-id" name="id" required>
                <label for="add-name">名称:</label>
                <input type="text" id="add-name" name="name" required>
                <label for="add-category">类别:</label>
                <input type="text" id="add-category" name="category" required>
                <label for="add-department">部门:</label>
                <input type="text" id="add-department" name="department" required>
                <label for="add-location">位置:</label>
                <input type="text" id="add-location" name="location" required>
                <button type="submit">添加</button>
            </form>
            <p id="add-key-message"></p>
        </div>

        <div id="manage-keys-tab" class="tab-content">
            <h2>管理钥匙</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>类别</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="keys-table-body">
                    </tbody>
            </table>
            <p id="manage-key-message"></p>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://my-key-api.onrender.com';
    let token = localStorage.getItem('token');
    let userRole = localStorage.getItem('userRole');

    document.addEventListener('DOMContentLoaded', () => {
        if (token) {
            showTab('main-tab');
            fetchKeys();
        } else {
            showTab('login-tab');
        }
    });

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
    }

    // 登录表单提交
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();

            if (response.ok) {
                token = data.token;
                userRole = data.user.role;
                localStorage.setItem('token', token);
                localStorage.setItem('userRole', userRole);
                showTab('main-tab');
                fetchKeys();
            } else {
                document.getElementById('message').textContent = data.message;
            }
        } catch (error) {
            document.getElementById('message').textContent = '登录请求失败';
        }
    });

    // 获取钥匙列表
    async function fetchKeys() {
        if (!token) return;

        try {
            const response = await fetch(`${API_URL}/api/keys`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const keys = await response.json();

            if (response.ok) {
                renderKeys(keys);
            } else {
                document.getElementById('manage-key-message').textContent = '获取钥匙失败';
            }
        } catch (error) {
            document.getElementById('manage-key-message').textContent = '获取钥匙请求失败';
        }
    }

    function renderKeys(keys) {
        const tableBody = document.getElementById('keys-table-body');
        tableBody.innerHTML = '';
        keys.forEach(key => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${key.id}</td>
                <td>${key.name}</td>
                <td>${key.category}</td>
                <td>${key.status}</td>
                <td>
                    <button onclick="toggleKeyStatus(${key.id}, '${key.status}')">
                        ${key.status === '在库' ? '借出' : '归还'}
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // 借出/归还钥匙
    async function toggleKeyStatus(keyId, currentStatus) {
        if (!token) return;

        const newStatus = currentStatus === '在库' ? '借出' : '在库';
        const endpoint = `${API_URL}/api/keys/${keyId}/status`;

        try {
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: newStatus, holder: '测试用户' })
            });

            if (response.ok) {
                fetchKeys(); // 刷新列表
            } else {
                alert('操作失败');
            }
        } catch (error) {
            alert('操作请求失败');
        }
    }

    // 添加钥匙
    document.getElementById('add-key-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!token || userRole !== '总管理员') {
            document.getElementById('add-key-message').textContent = '只有管理员才能添加钥匙';
            return;
        }

        const id = document.getElementById('add-id').value;
        const name = document.getElementById('add-name').value;
        const category = document.getElementById('add-category').value;
        const department = document.getElementById('add-department').value;
        const location = document.getElementById('add-location').value;

        try {
            const response = await fetch(`${API_URL}/api/keys`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id, name, category, department, location })
            });

            if (response.ok) {
                document.getElementById('add-key-message').textContent = '钥匙添加成功';
                document.getElementById('add-key-form').reset();
                fetchKeys();
            } else {
                const data = await response.json();
                document.getElementById('add-key-message').textContent = data.message || '添加失败';
            }
        } catch (error) {
            document.getElementById('add-key-message').textContent = '添加钥匙请求失败';
        }
    });

    // 退出登录
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userRole');
        token = null;
        userRole = null;
        showTab('login-tab');
    }
</script>

</body>
</html>
